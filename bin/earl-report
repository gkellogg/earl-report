#!/usr/bin/env ruby
require 'rubygems'
$:.unshift(File.expand_path(File.join(File.dirname(__FILE__), "..", 'lib')))

require 'earl_report'
require 'getoptlong'

def run(input, options)
end

OPT_ARGS = [
  ["--base",              GetoptLong::REQUIRED_ARGUMENT,"Base URI to use when loading test manifest"],
  ["--bibRef",            GetoptLong::REQUIRED_ARGUMENT,"ReSpec BibRef of specification being reported upon"],
  ["--format", "-f",      GetoptLong::REQUIRED_ARGUMENT,"Format of output, one of 'ttl', 'json', or 'html'"],
  ["--json",              GetoptLong::NO_ARGUMENT,      "Input is a JSON-LD formatted result"],
  ["--manifest",          GetoptLong::REQUIRED_ARGUMENT,"Test manifest"],
  ["--name",              GetoptLong::REQUIRED_ARGUMENT,"Name of specification"],
  ["--output", "-o",      GetoptLong::REQUIRED_ARGUMENT,"Output report to file"],
  ["--query",             GetoptLong::REQUIRED_ARGUMENT,"Query, or file containing query for extracting information from Test manifest"],
  ["--template",          GetoptLong::OPTIONAL_ARGUMENT,"Specify or return default report template"],
  ["--verbose",           GetoptLong::NO_ARGUMENT,      "Detail on execution"],
  ["--help", "-?",        GetoptLong::NO_ARGUMENT,      "This message"]
]
def usage
  STDERR.puts %{
    Generate EARL report for mutliple test results against a test manifest.
    
    Usage: #{$0} [options] test-manifest test-result ...
  }.gsub(/^    /, '')
  width = OPT_ARGS.map do |o|
    l = o.first.length
    l += o[1].length + 2 if o[1].is_a?(String)
    l
  end.max
  OPT_ARGS.each do |o|
    s = "  %-*s  " % [width, (o[1].is_a?(String) ? "#{o[0,2].join(', ')}" : o[0])]
    s += o.last
    STDERR.puts s
  end
  exit(1)
end

opts = GetoptLong.new(*OPT_ARGS.map {|o| o[0..-2]})

options = {
  :format => :html,
  :io => STDOUT}

opts.each do |opt, arg|
  case opt
  when '--base'         then options[:base] = arg
  when '--bibRef'       then options[:bibRef] = arg
  when '--format'       then options[:format] = arg.to_sym
  when '--manifest'     then options[:manifest] = arg
  when '--query'        then options[:manifest] = arg
  when '--base'         then options[:base] = arg
  when '--json'         then options[:json] = true
  when '--name'         then options[:name] = arg
  when '--output'       then options[:io] = File.open(arg, "w")
  when '--template'     then options[:template] = arg
  when '--verbose'      then options[:verbose] = true
  when '--help'         then usage
  else
    options[opt.to_sym] = arg
  end
end

# If requesting template, just return it
if options.has_key?(:template) && options[:template].empty?
  File.open(File.expand_path("../../lib/earl_report/views/earl_report.html.haml", __FILE__)) do |f|
    options[:io].write(f.read)
  end
else
  earl = EarlReport.new(*ARGV, options)
  earl.generate(options)
end
